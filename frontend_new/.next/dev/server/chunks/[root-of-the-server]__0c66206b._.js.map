{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/dzikriah/Documents/workabroadly/frontend_new/app/api/chat/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\n\nconst OPENAI_API_KEY =\n  process.env.OPENAI_API_KEY ||\n  \"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\"\n\nconst EXPAT_AI_PROMPT = `You are Expat AI, an intelligent assistant helping Indonesian professionals prepare to work abroad, specifically in Japan and South Korea.\n\nYour role is to guide users through all general preparations needed for working abroad, maintaining accuracy, empathy, and contextual relevance.\n\nLANGUAGE SUPPORT:\n- Respond in the language specified by the user (English, Indonesian, Japanese, or Korean)\n- Maintain the same professional and helpful tone across all languages\n- Use culturally appropriate expressions and formalities for each language\n\nSCOPE CONTROL:\nYou MUST limit knowledge and discussion ONLY to Japan and South Korea.\nIf users ask about other countries (USA, Canada, Australia, Europe, etc.), respond ONLY with:\n- English: \"Sorry, Expat AI only focuses on helping Indonesian professionals work in Japan or South Korea.\"\n- Indonesian: \"Maaf, Expat AI hanya berfokus membantu warga Indonesia yang ingin bekerja ke Jepang atau Korea Selatan.\"\n- Japanese: \"申し訳ございませんが、Expat AIは日本と韓国で働くインドネシア人専門家のサポートのみに焦点を当てています。\"\n- Korean: \"죄송합니다. Expat AI는 일본과 한국에서 일하는 인도네시아 전문가를 돕는 데만 집중합니다.\"\n\nBEHAVIORAL PRINCIPLES:\n- Always provide complete and actionable answers\n- If user questions are unclear, clarify by summarizing your assumptions first\n- Prioritize accuracy over speculation\n- Use a neutral, encouraging, and professional tone\n- Prefer bullet points and structured sections for clarity\n- Offer practical steps, not just abstract concepts\n- Include brief cultural insights or dos and don'ts when relevant\n- When mentioning legal or official processes, clarify with: \"Note: Always confirm with the latest guidance from the embassy or immigration office.\"\n\nFORMATTING:\n- Always use semantic Markdown with headings, lists, bold text, and tables\n- Include short section titles with emojis\n- Keep responses moderate length (3-5 sentences per paragraph)\n- Separate paragraphs with line breaks\n\nRESPONSE TEMPLATE:\n1. Brief greeting or summary\n2. Structured sections with icons and headings\n3. Notes or disclaimers\n4. Encouraging closing statement`\n\nconst profiles = {\n  default: EXPAT_AI_PROMPT,\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { message, role = \"default\", language = \"en\", conversationHistory = [] } = await request.json()\n\n    if (!message || typeof message !== \"string\") {\n      return NextResponse.json({ error: \"Message is required and must be a string\" }, { status: 400 })\n    }\n\n    const languageInstruction =\n      {\n        en: \"Respond in English.\",\n        id: \"Respond in Indonesian (Bahasa Indonesia).\",\n        ja: \"Respond in Japanese (日本語).\",\n        ko: \"Respond in Korean (한국어).\",\n      }[language] || \"Respond in English.\"\n\n    const messages = [\n      {\n        role: \"system\",\n        content: `${profiles[role as keyof typeof profiles] || profiles.default}\\n\\nIMPORTANT: ${languageInstruction}`,\n      },\n      ...conversationHistory.map((msg: { role: string; content: string }) => ({\n        role: msg.role,\n        content: msg.content,\n      })),\n      {\n        role: \"user\",\n        content: message,\n      },\n    ]\n\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 30000)\n\n    let response\n    try {\n      response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${OPENAI_API_KEY}`,\n        },\n        body: JSON.stringify({\n          model: \"gpt-4o-mini\",\n          messages: messages,\n          max_completion_tokens: 1500,\n        }),\n        signal: controller.signal,\n      })\n    } catch (fetchError) {\n      clearTimeout(timeoutId)\n\n      if (fetchError instanceof Error && fetchError.name === \"AbortError\") {\n        return NextResponse.json(\n          {\n            error: \"REQUEST_TIMEOUT\",\n            userMessage: \"Koneksi timeout. Mohon coba lagi dalam beberapa saat.\",\n          },\n          { status: 504 },\n        )\n      }\n\n      return NextResponse.json(\n        {\n          error: \"NETWORK_ERROR\",\n          userMessage: \"Tidak dapat terhubung ke server. Periksa koneksi internet Anda.\",\n        },\n        { status: 503 },\n      )\n    }\n\n    clearTimeout(timeoutId)\n\n    if (!response.ok) {\n      const errorData = await response.text()\n      let errorJson\n      try {\n        errorJson = JSON.parse(errorData)\n      } catch {\n        errorJson = { error: { message: errorData } }\n      }\n\n      const errorCode = errorJson.error?.code || \"UNKNOWN_ERROR\"\n\n      if (response.status === 401) {\n        return NextResponse.json(\n          {\n            error: \"INVALID_API_KEY\",\n            userMessage: \"API key tidak valid. Silakan periksa API key di Vars section.\",\n          },\n          { status: 401 },\n        )\n      }\n\n      if (response.status === 429) {\n        return NextResponse.json(\n          {\n            error: \"RATE_LIMIT_EXCEEDED\",\n            userMessage: \"Terlalu banyak permintaan. Mohon tunggu beberapa saat dan coba lagi.\",\n          },\n          { status: 429 },\n        )\n      }\n\n      return NextResponse.json(\n        {\n          error: errorCode,\n          userMessage: \"Terjadi kesalahan. Silakan coba lagi.\",\n        },\n        { status: response.status },\n      )\n    }\n\n    const data = await response.json()\n\n    if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {\n      return NextResponse.json(\n        {\n          error: \"EMPTY_RESPONSE\",\n          userMessage: \"AI tidak dapat memberikan jawaban saat ini. Silakan coba lagi.\",\n        },\n        { status: 500 },\n      )\n    }\n\n    const choice = data.choices[0]\n    if (!choice.message || !choice.message.content) {\n      return NextResponse.json(\n        {\n          error: \"EMPTY_CONTENT\",\n          userMessage: \"AI tidak memberikan jawaban. Silakan coba dengan pertanyaan lain.\",\n        },\n        { status: 500 },\n      )\n    }\n\n    const reply = choice.message.content.trim()\n\n    if (!reply) {\n      return NextResponse.json(\n        {\n          error: \"EMPTY_REPLY\",\n          userMessage: \"Tidak ada respons dari AI. Silakan coba lagi.\",\n        },\n        { status: 500 },\n      )\n    }\n\n    return NextResponse.json({ reply })\n  } catch (error) {\n    return NextResponse.json(\n      {\n        error: \"INTERNAL_ERROR\",\n        userMessage: \"Terjadi kesalahan sistem. Silakan coba lagi atau hubungi administrator.\",\n        details: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,iBACJ,QAAQ,GAAG,CAAC,cAAc,IAC1B;AAEF,MAAM,kBAAkB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;gCAqCO,CAAC;AAEjC,MAAM,WAAW;IACf,SAAS;AACX;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,OAAO,SAAS,EAAE,WAAW,IAAI,EAAE,sBAAsB,EAAE,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEnG,IAAI,CAAC,WAAW,OAAO,YAAY,UAAU;YAC3C,OAAO,6LAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2C,GAAG;gBAAE,QAAQ;YAAI;QAChG;QAEA,MAAM,sBACJ;YACE,IAAI;YACJ,IAAI;YACJ,IAAI;YACJ,IAAI;QACN,CAAC,CAAC,SAAS,IAAI;QAEjB,MAAM,WAAW;YACf;gBACE,MAAM;gBACN,SAAS,GAAG,QAAQ,CAAC,KAA8B,IAAI,SAAS,OAAO,CAAC,eAAe,EAAE,qBAAqB;YAChH;eACG,oBAAoB,GAAG,CAAC,CAAC,MAA2C,CAAC;oBACtE,MAAM,IAAI,IAAI;oBACd,SAAS,IAAI,OAAO;gBACtB,CAAC;YACD;gBACE,MAAM;gBACN,SAAS;YACX;SACD;QAED,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,IAAI;QACJ,IAAI;YACF,WAAW,MAAM,MAAM,8CAA8C;gBACnE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe,CAAC,OAAO,EAAE,gBAAgB;gBAC3C;gBACA,MAAM,KAAK,SAAS,CAAC;oBACnB,OAAO;oBACP,UAAU;oBACV,uBAAuB;gBACzB;gBACA,QAAQ,WAAW,MAAM;YAC3B;QACF,EAAE,OAAO,YAAY;YACnB,aAAa;YAEb,IAAI,sBAAsB,SAAS,WAAW,IAAI,KAAK,cAAc;gBACnE,OAAO,6LAAY,CAAC,IAAI,CACtB;oBACE,OAAO;oBACP,aAAa;gBACf,GACA;oBAAE,QAAQ;gBAAI;YAElB;YAEA,OAAO,6LAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,aAAa;YACf,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,aAAa;QAEb,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,IAAI;YACJ,IAAI;gBACF,YAAY,KAAK,KAAK,CAAC;YACzB,EAAE,OAAM;gBACN,YAAY;oBAAE,OAAO;wBAAE,SAAS;oBAAU;gBAAE;YAC9C;YAEA,MAAM,YAAY,UAAU,KAAK,EAAE,QAAQ;YAE3C,IAAI,SAAS,MAAM,KAAK,KAAK;gBAC3B,OAAO,6LAAY,CAAC,IAAI,CACtB;oBACE,OAAO;oBACP,aAAa;gBACf,GACA;oBAAE,QAAQ;gBAAI;YAElB;YAEA,IAAI,SAAS,MAAM,KAAK,KAAK;gBAC3B,OAAO,6LAAY,CAAC,IAAI,CACtB;oBACE,OAAO;oBACP,aAAa;gBACf,GACA;oBAAE,QAAQ;gBAAI;YAElB;YAEA,OAAO,6LAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,aAAa;YACf,GACA;gBAAE,QAAQ,SAAS,MAAM;YAAC;QAE9B;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,IAAI,CAAC,KAAK,OAAO,IAAI,CAAC,MAAM,OAAO,CAAC,KAAK,OAAO,KAAK,KAAK,OAAO,CAAC,MAAM,KAAK,GAAG;YAC9E,OAAO,6LAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,aAAa;YACf,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,KAAK,OAAO,CAAC,EAAE;QAC9B,IAAI,CAAC,OAAO,OAAO,IAAI,CAAC,OAAO,OAAO,CAAC,OAAO,EAAE;YAC9C,OAAO,6LAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,aAAa;YACf,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI;QAEzC,IAAI,CAAC,OAAO;YACV,OAAO,6LAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,aAAa;YACf,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,6LAAY,CAAC,IAAI,CAAC;YAAE;QAAM;IACnC,EAAE,OAAO,OAAO;QACd,OAAO,6LAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,aAAa;YACb,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}